#!/usr/local/bin/coffee

Fraction = require('fractional').Fraction
colors = require 'colors'
argv = require 'yargs'
  .usage 'Usage: $0 [options]'
  .alias 'k', 'key'
  .describe 'k', 'Harmonica key'
  .default 'k', 'C'
  .alias 'p', 'progression'
  .describe 'p', 'Scale or chord progression'
  .default 'p', 'scale major'
  .alias 't', 'tonality'
  .describe 't', 'Progression tonality'
  #.default 't', 'C'
  .alias 'o', 'octaves'
  .describe 'o', 'Octave range between 1 and 3'
  .default 'o', '1-3'
  .help 'h'
  .alias 'h', 'help'
  .epilog 'author: IceOnFire'
  .argv

harpman = require '../harpman'
progressions = (require 'cson').requireFile 'data/progressions.cson'

harpkey = argv.k
progression = argv.p
tonality = argv.t || harpkey
octaves = argv.o

tokens = progression.split ' '
progression = progressions
for token in tokens
  progression = progression[token]

tokens = octaves.split '-'
octave = tokens[0]
octave -= 1
octaves = tokens[1]

process.stdout.write 'intv\t'
theIntervals = harpman.getIntervals progression, octave, octaves

for theInterval in theIntervals
  if theInterval % 1 is 0
    theInterval = '     ' + theInterval
  else if theInterval / 1 - theInterval % 1 <= 0
    theInterval = '    ' + new Fraction(theInterval).toString()
  else
    theInterval = '  ' + new Fraction(theInterval).toString()
  process.stdout.write theInterval + '\t'
process.stdout.write '\n'

process.stdout.write 'step\t'
theSteps = harpman.getSteps progression, octave, octaves
for step in theSteps
  process.stdout.write step + '\t'
process.stdout.write '\n'

process.stdout.write 'note\t'
theNotes = harpman.getNotes progression, tonality, octave, octaves
for theNote, i in theNotes
  if i % progression.length is 0 # tonic
    theNote = colors.green.bold theNote
  else if (i % progression.length) % 6 is 0 # leading
    theNote = colors.magenta.bold theNote
  else if (i % progression.length) % 4 is 0 # dominant
    theNote = colors.blue.bold theNote
  else if (i % progression.length) % 2 is 0 # mediant
    theNote = colors.yellow.dim theNote
  process.stdout.write theNote + '\t'
process.stdout.write '\n'

process.stdout.write 'hole\t'
theHoles = harpman.getHoles harpkey, progression, tonality, octave, octaves
for theHole, i in theHoles
  if i % progression.length is 0 # tonic
    theHole = colors.green.bold theHole
  else if (i % progression.length) % 6 is 0 # leading
    theHole = colors.magenta.bold theHole
  else if (i % progression.length) % 4 is 0 # dominant
    theHole = colors.blue.bold theHole
  else if (i % progression.length) % 2 is 0 # mediant
    theHole = colors.yellow.dim theHole
  process.stdout.write theHole + '\t'
process.stdout.write '\n'
